<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Week</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="The week schedule">

    <!-- Le styles -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-responsive.css" rel="stylesheet">
    <link href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png">
    <link rel="shortcut icon" href="ico/favicon.png">
    <!-- CUSTOM CSS -->
    <style>
      body {
        background-color: #FFFFF0;
      }
      .employees {
        background-color: red;
        height: 500px;
        float: left;
      }
      .week {
        border: 1px solid black;
        height: 500px;
      }
      .morning td, .evening td{
      }
      #draggable, ol {
        margin: 0px 0px;
        padding-top: 15px;
        padding-bottom: 15px;
      }
      #draggable ol {
        margin-bottom: 10px;
        background-color: gray;
        text-align: center;
      }
      .ui-draggable {
        padding-top: 15px;
        padding-bottom: 15px;
        background-color: blue;
      }
      .red-zone {
        background-color: rgba(255, 105, 97, 0.5);
      }
      .yellow-zone {
        background-color: rgba(255, 255, 187, 0.5);
      }
      .green-zone {
        background-color: rgba(189,236,182, 0.5);
      }
      .hidden {
        display: none;
        background-color: green;
        font-size: 100px;
      }
      
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row-fluid">

        <div class="employees span2">
          <h3>Employees +</h3>
          <ul id="draggable">
            <ol class="tour captain">Colin Bookman</ol>
            <ol class="tour captain">John Doe</ol>
            <ol class="captain">Emp 1</ol>
            <ol class="captain captain">John 2</ol>
            <ol class="staff captain">John 3</ol>
            <ol class="staff captain">John 4</ol>
            <ol class="staff captain">John 5</ol>
            <ol class="staff captain">John 6</ol>
            <ol class="staff captain">John 7</ol>

          </ul>
        </div>

        <table class="week span10 table">
          <thead>
            <tr>
              <th>Shift</th>
              <th>Sunday    <br/>6/16/2013</th>
              <th>Monday    <br/>6/17/2013</th>
              <th>Tuesday   <br/>6/18/2013</th>
              <th>Wednesday <br/>6/19/2013</th>
              <th>Thursday  <br/>6/20/2013</th>
              <th>Friday    <br/>6/21/2013</th>
              <th>Saturday  <br/>6/22/2013</th>
            </tr>
          </thead>
          <tbody id="droppable">
            <tr id="morning">
              <td>Morning</td>
              <script>
                for(var i = 0; i<7; i++) { 
                  document.write(' \
                    <td id="morning-'+i+'" class="red-zone"> \
                      Need: \
                      <ul> \
                        <li><span class="tour">2</span> Tour Guides</li> \
                        <li><span class="captain">2</span> Captains</li>  \
                        <li><span class="staff">5</span> Staf</li> \
                      </ul> \
                    </td>');
                }
              </script>
            </tr>
            <script>
            </script>
            <tr id="afternoon">
              <td>Afternoon</td>
              <script>
              for(var i = 0; i<7; i++) { 
                document.write(' \
                  <td id="afternoon-'+i+'" class="red-zone"> \
                    Need: \
                    <ul>  \
                      <li><span class="tour">2</span> Tour Guides</li> \
                      <li><span class="captain">2</span> Captains</li>  \
                      <li><span class="staff">5</span> Staff</li> \
                    </ul> \
                  </td>');        
              }
              </script>
            </tr>
            <tr id="evening">
              <td>Evening</td>
              <script>
              for(var i = 0; i<7; i++) { 
                document.write(' \
                  <td id= "evening-'+i+'" class="red-zone"> \
                    Need: \
                    <ul>  \
                      <li><span class="tour">2</span> Tour Guides</li> \
                      <li><span class="captain">2</span> Captains</li>  \
                      <li><span class="staff">5</span> Staff</li> \
                    </ul> \
                  </td>');        
              }
              </script>
            </tr>
          </tbody>
        </table>
      </div>
    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
     <script src="http://code.jquery.com/jquery.js"></script>
     <script src="js/bootstrap.min.js"></script>
     <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <!-- Draggable Script -->
     <script>
     //Red = Not Meeting 
     //Yellow = Just Meeting (all most be yellow)
     //Green = All Good - Everything Meets and a few Exceeds (all yellow and a green somewhere)
     //Checks for <=Red, >= Green, and the else
      var requirements = {
        "tour" : {
          "red" : 1,
          "yellow" : 2,
          "green"  : 4
        },
        "captain" : {
          "red" : 1,
          "yellow" : 2,
          "green"  : 2
        },
        "staff" : {
          "red" : 4,
          "yellow" : 5,
          "green" : 7,
        }
      }

      //which position to fill first
      var positions = ["captain", "tour", "staff"];
      //Data for each day
      var daysofweek = ['sunday', 'monday', 'tuesday', 'wednesday' ,'thursday', 'friday', 'saturday'];
      var scheduled = {
        "sunday" : {
          "morning"   : {"tour": [], "captain" : [], "staff" : []},
          "afternoon" : {"tour": [], "captain" : [], "staff" : []},
          "evening"   : {"tour": [], "captain" : [], "staff" : []}
        },
        "monday" : {
          "morning"   : {"tour": [], "captain" : [], "staff" : []},
          "afternoon" : {"tour": [], "captain" : [], "staff" : []},
          "evening"   : {"tour": [], "captain" : [], "staff" : []}
        },
        "tuesday" : {
          "morning"   : {"tour": [], "captain" : [], "staff" : []},
          "afternoon" : {"tour": [], "captain" : [], "staff" : []},
          "evening"   : {"tour": [], "captain" : [], "staff" : []}
        },
        "wednesday" : {
          "morning"   : {"tour": [], "captain" : [], "staff" : []},
          "afternoon" : {"tour": [], "captain" : [], "staff" : []},
          "evening"   : {"tour": [], "captain" : [], "staff" : []}
        },
        "thursday" : {
          "morning"   : {"tour": [], "captain" : [], "staff" : []},
          "afternoon" : {"tour": [], "captain" : [], "staff" : []},
          "evening"   : {"tour": [], "captain" : [], "staff" : []}
        },
        "friday" : {
          "morning"   : {"tour": [], "captain" : [], "staff" : []},
          "afternoon" : {"tour": [], "captain" : [], "staff" : []},
          "evening"   : {"tour": [], "captain" : [], "staff" : []}
        },
        "saturday" : {
          "morning"   : {"tour": [], "captain" : [], "staff" : []},
          "afternoon" : {"tour": [], "captain" : [], "staff" : []},
          "evening"   : {"tour": [], "captain" : [], "staff" : []}
        }
      }
      $(function() {
        $( "#draggable ol" ).draggable({
          appendTo: "body",
          helper: "clone"
        });
        $("#droppable td" ).droppable({
          activeClass: "ui-state-default",
          hoverClass: "ui-state-hover",
          accept: ":not(.ui-sortable-helper)",
          drop: function( event, ui ) {
            $( this ).find( ".placeholder" ).remove();
            dropped(ui.draggable, this); //Name , Cell
          }
        }).sortable({
          items: "li:not(.placeholder)",
          sort: function() {
            // gets added unintentionally by droppable interacting with sortable
            // using connectWithSortable fixes this, but doesn't allow you to customize active/hoverClass options
            $( this ).removeClass( "ui-state-default" );
          }
        });
      });
      var test;
      function dropped(name, cell) {
        //Find out day which dropped into
        var time = cell.id.split('-');
        var day = daysofweek[time[1]];
        var period = time[0];
        var selectedEmployee = name.text();

        //See if already in the timeslot, assert Error
        var currentlyScheduled = scheduled[day][period];
        for(var i = 0; i<positions.length; i++) {
          if(currentlyScheduled[positions[i]].indexOf(selectedEmployee) != -1) {
              return error("EMPLOYEE ALREADY ADDED TO THIS TIMESLOT");
          }
        }

        //Add Employee to Schedule       
        var skills = name.attr('class').split(' ');
        skills.pop(); //Remove ui-draggable (last class)

        var chosenSkill = skills[0]; //TODO Smarter Skill assignment
        //TODO FIX 1 Skillset per employee assumption
        scheduled[day][period][chosenSkill].push(selectedEmployee); //Assuming employee only has 1 skil 
        /////////////////////////////////////////////////
        ///////////   UGLY SHOULD BE DO WHILE   /////////
        /////////////////////////////////////////////////
        //Decrement correct LI for adding slot
        var cell_ul = cell.childNodes[1].childNodes;
        test = cell_ul;
        for(var i = 1; i<cell_ul.length; i+=2) {
          var liElm = cell_ul[i];
          if(liElm.childNodes[0].className  == chosenSkill) {
            var spanElm = cell_ul[i].childNodes[0];
            if(spanElm.innerHTML <= 1) { //Delete Node
              liElm.className += "hidden";
            } else { //Decrement counter
              spanElm.innerHTML -= 1;
            }
            break; //Found our element, stop the loop
          }
        }

        //Assign Correct Shading
        var red = 0;  var yellow = 0; var green = 0;
        for(var i =0; i<positions.length; i++) { 
          var numStationed = scheduled[day][period][positions[i]].length;
          if(numStationed <= requirements[positions[i]]["red"]) {
            red++;
          } else if(numStationed >= requirements[positions[i]]["green"]) {
            green++;
          } else {
            yellow++;
          }
        }
        //Shade Red
        if(red > 0) {
          alert("RED");
        } else if(yellow > green) {
          alert("Yellow");
        } else {
          alert("GREEN");
        }

      }
      function error(error_message) {
        alert(error_message);
      }
     </script>
  </body>
</html>
